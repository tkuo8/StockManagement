# 株管理アプリ 内部設計書

## **1. 目的**

本アプリケーションは、株式投資の効率的な管理を目的とし、ユーザーがリスク分散と資産成長を目指すための支援ツールを提供します。株式の購入・売却履歴管理、目標設定、進捗の可視化、株価情報の自動取得を通じて、投資家が意思決定を合理的に行えるように設計されています。

---

## **2. システム構成**

システムは以下の構成要素から成ります：

- **フロントエンド**: React, Bootstrap
- **バックエンド**: Java (Spring Boot)
- **データベース**: MySQL
- **外部 API**: Yahoo Finance API, Alpha Vantage API
- **認証・認可**: JWT (JSON Web Token)

React を使用してユーザーインターフェースを構築し、株価やテクニカル指標データは外部 API を通じて取得します。バックエンドでは RESTful API を提供し、データ管理を行います。

---

## **3. データベース設計**

### **3.1 エンティティ設計**

#### **1. User（ユーザー）テーブル**

ユーザー情報を管理します。

- **user_id** (INT, PK): 主キー。自動インクリメント。
- **email** (VARCHAR(255)): ユーザーのメールアドレス（ユニーク制約）。
- **password** (VARCHAR(255)): ハッシュ化されたパスワード。
- **created_at** (TIMESTAMP): 作成日時。
- **updated_at** (TIMESTAMP): 更新日時。

---

#### **2. Stock（株情報）テーブル**

保有株情報を管理します。

- **stock_id** (INT, PK): 主キー。自動インクリメント。
- **user_id** (INT, FK): ユーザー ID（`User`テーブル参照）。
- **symbol** (VARCHAR(10)): 株式のティッカーシンボル。
- **purchase_price** (DECIMAL(10,2)): 購入価格。
- **quantity** (INT): 保有株数。
- **target_price** (DECIMAL(10,2)): 売却目標価格。
- **stop_loss_price** (DECIMAL(10,2)): 損切り価格。
- **status** (VARCHAR(50)): 状態（例: "holding", "watching", "buy", "sell"）。
- **created_at** (TIMESTAMP): 作成日時。
- **updated_at** (TIMESTAMP): 更新日時。

---

#### **3. Transaction（取引履歴）テーブル**

取引履歴を記録します。

- **transaction_id** (INT, PK): 主キー。自動インクリメント。
- **stock_id** (INT, FK): 株情報 ID（`Stock`テーブル参照）。
- **type** (ENUM('BUY', 'SELL')): 取引の種類。
- **price** (DECIMAL(10,2)): 取引価格。
- **quantity** (INT): 取引株数。
- **transaction_date** (TIMESTAMP): 取引日時。

---

#### **4. Alert（アラート設定）テーブル**

アラート情報を管理します。

- **alert_id** (INT, PK): 主キー。自動インクリメント。
- **user_id** (INT, FK): ユーザー ID（`User`テーブル参照）。
- **stock_id** (INT, FK): 株情報 ID（`Stock`テーブル参照）。
- **alert_type** (ENUM('PRICE', 'TARGET_REACHED')): アラートの種類。
- **alert_value** (DECIMAL(10,2)): アラート基準値。
- **created_at** (TIMESTAMP): 作成日時。

---

#### **5. Indicator（テクニカル指標）テーブル**

各銘柄のテクニカル指標を記録します。

- **indicator_id** (INT, PK): 主キー。自動インクリメント。
- **stock_id** (INT, FK): 株情報 ID（`Stock`テーブル参照）。
- **indicator_name** (VARCHAR(50)): 指標名（例: "MACD", "RSI"）。
- **value** (DECIMAL(10,2)): 指標値。
- **calculated_at** (TIMESTAMP): 計算日時。

---

### **3.2 インデックス設計**

- `User`テーブル: `email`列にユニークインデックス。
- `Stock`テーブル: `user_id`列にインデックス。
- `Transaction`テーブル: `stock_id`列、`transaction_date`列にインデックス。
- `Alert`テーブル: `user_id`列、`stock_id`列にインデックス。

---

## **4. API 設計**

### **4.1 株情報管理 API**

#### **1. 登録**

- **エンドポイント**: `POST /api/stocks`
- **リクエスト**:
  ```json
  {
    "symbol": "AAPL",
    "purchase_price": 150.0,
    "quantity": 10,
    "target_price": 160.0,
    "stop_loss_price": 140.0,
    "status": "holding"
  }
  ```
- **レスポンス**:
  ```json
  {
    "stock_id": 1,
    "symbol": "AAPL",
    "purchase_price": 150.0,
    "quantity": 10,
    "target_price": 160.0,
    "stop_loss_price": 140.0,
    "status": "holding"
  }
  ```

---

### **4.2 アラート管理 API**

#### **1. 設定**

- **エンドポイント**: `POST /api/alerts`
- **リクエスト**:
  ```json
  {
    "user_id": 1,
    "stock_id": 1,
    "alert_type": "PRICE",
    "alert_value": 145.0
  }
  ```
- **レスポンス**:
  ```json
  {
    "alert_id": 1,
    "user_id": 1,
    "stock_id": 1,
    "alert_type": "PRICE",
    "alert_value": 145.0
  }
  ```

---

## 5. ロジック設計

### 5.1 ユーザー認証・認可

#### 5.1.1 ログイン処理

- ユーザーがログイン画面で「ユーザー名」と「パスワード」を入力します。
- 入力されたユーザー名に対応する`User`テーブルのレコードを検索します。
- ユーザーが存在すれば、入力されたパスワード（ハッシュ化されたもの）とデータベースに保存されたパスワードハッシュを照合します。
- パスワードが一致すれば、ユーザー認証が成功し、認証トークン（JWT 等）が発行され、ユーザーのセッションが開始されます。
- パスワードが一致しない場合、エラーメッセージを表示し、ログイン失敗を通知します。

#### 5.1.2 ユーザー登録処理

- ユーザーが新規登録画面で「ユーザー名」「メールアドレス」「パスワード」を入力します。
- 入力されたメールアドレスが既に`User`テーブルに存在するかをチェックします。
- 存在しない場合、パスワードはハッシュ化して`User`テーブルに新しいレコードを作成します。
- ユーザー登録が成功した後、確認メールを送信し、ユーザーにアクティベーションのリンクを提供します。

#### 5.1.3 ログアウト処理

- ユーザーがログアウトを選択すると、認証トークンが無効化され、セッションが終了します。
- クッキーやセッションストレージ内の情報を削除し、再度認証を要求します。

---

### 5.2 株情報管理

#### 5.2.1 株の登録

- ユーザーが新しい株情報を入力し、「購入価格」「数量」「目標価格」などの詳細を入力します。
- 入力された情報は`Stock`テーブルに新しいレコードとして登録されます。
- 株の登録時に、`symbol`が既に登録されているかどうかを確認し、重複登録を防止します。

#### 5.2.2 株の情報更新

- ユーザーは保有株情報を更新でき、購入価格や数量を変更することができます。
- 更新された情報は、`Stock`テーブルの対応するレコードを更新します。
- 更新の際、目標価格に達した場合には、`Alert`テーブルのアラートをトリガーとして通知を送信する仕組みが動作します。

#### 5.2.3 株の削除

- ユーザーは保有株を削除することができます。
- 削除される株情報は`Stock`テーブルから削除されますが、関連する取引履歴は残すべきであり、`Transaction`テーブルからは削除しません。
- 株の削除後に、関連するアラート情報も削除されます。

---

### 5.3 取引履歴管理

#### 5.3.1 取引の登録

- ユーザーが株の購入または売却を行う際、取引の詳細を入力します。
- 取引のタイプ（購入・売却）を選択し、株の価格や数量を入力します。
- 取引の情報は`Transaction`テーブルに新しいレコードとして登録されます。
- 取引後、株の保有数量が更新されます。

#### 5.3.2 取引の履歴確認

- ユーザーは過去に行った取引履歴を一覧表示することができます。
- 取引履歴は、`Transaction`テーブルから`stock_id`または`transaction_date`を基にフィルタリングし、日時順に表示します。

---

### 5.4 アラート機能

#### 5.4.1 アラートの登録

- ユーザーは特定の株に対して価格アラートを設定できます。設定した価格に達した際に通知が送信されます。
- ユーザーがアラートを設定した場合、その情報は`Alert`テーブルに新しいレコードとして追加されます。
- アラートには、アラートタイプ（価格に達した場合、目標価格に達した場合）を設定でき、`alert_value`にその価格を記録します。

#### 5.4.2 アラートの通知

- アラート設定の価格に株価が達成された場合、システムは該当ユーザーに対して通知を送信します。
- 通知内容には、株のティッカーシンボル、現在の価格、目標価格などを含めます。

#### 5.4.3 アラートの削除

- ユーザーは不要になったアラートを削除することができます。
- アラートは`Alert`テーブルから削除され、以降そのアラートは無効になります。

---

### 5.5 株価データ取得

#### 5.5.1 株価の取得処理

- 外部 API（例：Yahoo Finance、Alpha Vantage）を使用して、株式の最新価格を取得します。
- 株価データは一定の間隔で更新され、ユーザーが保有している株の現在の価格を自動的に反映します。
- 株価が更新されるたびに、`Stock`テーブルの該当株情報が更新されます。

#### 5.5.2 価格の更新頻度

- 株価データは、API の制限に基づき、定期的に（例えば、1 時間毎）更新します。
- リアルタイムの株価を表示する場合は、クライアントサイドでの更新を行うことも検討します。

---

### 5.6 エラーハンドリング

#### 5.6.1 一般的なエラー処理

- 各 API 呼び出しやデータベース操作において、エラーが発生した場合、適切なエラーメッセージをログに記録します。
- エラーが発生した際、ユーザーに対して「操作が失敗しました」といった一般的なメッセージを表示し、システムの状態が不安定でないことを伝えます。

#### 5.6.2 データベースエラー

- データベースにアクセス中にエラーが発生した場合、詳細なエラーログを記録し、システム管理者に通知します。
- ユーザーには、予期しないエラーが発生した旨のメッセージを表示し、再試行のオプションを提示します。

---

### 5.7 通知機能

#### 5.7.1 通知処理

- ユーザーが設定したアラートに基づき、株価が条件を満たした場合に通知を送信します。
- 通知方法には、メールやアプリ内通知などが考えられます。

#### 5.7.2 メール通知

- アラートが発動した場合、ユーザーに株価アラートの内容をメールで通知します。
- メールには、アラート対象の株情報、現在の株価、目標株価などを含めます。

---

## 6. フロントエンド設計

### 6.1 使用技術

- **HTML5**: ページの構造を定義します。セマンティック HTML を使用して、アクセシビリティの向上と SEO 効果を高めます。
- **CSS3**: 見た目のデザインを担当します。レスポンシブデザインを採用し、ユーザーのデバイスに応じたレイアウト調整を行います。
- **JavaScript (ES6+)**: インタラクティブな要素（ボタンのクリック、フォームの送信等）を制御します。
- **React**: UI コンポーネントを効率的に作成・管理します。React Hooks や Context API を利用して状態管理を行います。
- **Redux (オプション)**: 状態管理が複雑な場合に利用します。グローバルステートを管理するために使います。
- **Bootstrap**: レスポンシブデザインを簡単に実装するために使用します。UI コンポーネント（ボタン、ナビゲーションバー等）のスタイリングを簡便に行います。
- **Axios (または Fetch API)**: サーバーとの通信に使用します。GET、POST などの HTTP リクエストを扱い、バックエンドとデータをやり取りします。

---

### 6.2 レイアウト設計

#### 6.2.1 ヘッダー

- **内容**: ロゴ、アプリ名、ユーザーアイコン、ログイン・ログアウトボタンなどを表示。
- **機能**: ログイン状態に応じて、「ログイン」ボタンまたは「ログアウト」ボタンが表示される。ユーザー情報が表示される場合もある。

#### 6.2.2 ナビゲーションバー

- **内容**: ユーザーがアプリ内の異なるページに移動できるリンク（ダッシュボード、株管理、取引履歴、設定など）。
- **機能**: ページ遷移を提供するため、React Router を使用して動的にページを切り替える。

#### 6.2.3 メインコンテンツエリア

- **内容**: 株情報や取引履歴など、ユーザーが最もアクセスする情報を表示するエリア。
- **機能**: ユーザーのインタラクションに基づいて動的にコンテンツを更新。React の状態管理を活用して、ユーザーが行った操作に応じて画面を再レンダリングします。

#### 6.2.4 フッター

- **内容**: サイトマップ、プライバシーポリシー、利用規約などのリンクを表示。
- **機能**: 固定表示され、どのページでも常に画面下部に表示される。

---

### 6.3 ユーザーインターフェース設計

#### 6.3.1 ログイン画面

- **フォーム項目**:
  - ユーザー名、パスワード、ログインボタン
- **入力検証**:
  - ユーザー名とパスワードが正しい形式で入力されているかをクライアントサイドで確認。
  - エラーメッセージ（例えば「ユーザー名が間違っています」「パスワードが間違っています」）を表示。
- **機能**: ログインボタンをクリックすると、バックエンドに認証リクエストを送信し、認証成功後にダッシュボードページに遷移します。

#### 6.3.2 ダッシュボード画面

- **内容**:
  - ユーザーが保有する株の一覧を表示（株名、現在の価格、購入価格、保有数、評価額など）。
  - 目標株価に達した場合のアラート通知。
  - 株の購入・売却ボタン、株情報の更新ボタンを配置。
  - 株の状態管理（買い時待ち、売り時待ち、買い検討の状態）を表示。
- **インタラクション**:
  - 株の詳細情報をクリックすると、詳細な取引履歴や目標価格設定を行えるページに遷移。
- **使用技術**
  - React Table

#### 6.3.3 株管理画面

- **内容**:
  - 新しい株を追加するフォーム（株名、購入価格、数量、目標価格など）。
  - 既存の株情報を編集または削除するインターフェース。
- **機能**:
  - フォーム入力時に、株名が既に登録されているかのチェックを行い、重複登録を防止。
  - 株の更新時、リアルタイムで最新の株価を表示。

#### 6.3.4 取引履歴画面

- **内容**:
  - ユーザーが過去に行った株の購入・売却履歴を一覧表示。
  - 取引日時、株名、価格、数量、取引タイプ（購入・売却）など。
- **インタラクション**:
  - 各取引の詳細を表示するリンクをクリックすると、その取引の詳細情報がポップアップまたは新しいページで表示されます。

#### 6.3.5 アラート画面

- **内容**:
  - ユーザーが設定した価格アラートの一覧（アラート対象の株、アラート設定価格、現在の株価）。
  - アラート設定を変更または削除するための操作を提供。
- **インタラクション**:
  - アラート価格が現在の株価に達した場合、アラートの状態を「発動済み」と表示。

---

### 6.4 状態管理

#### 6.4.1 グローバルステート管理

- **使用技術**: React の`useContext`と`useReducer`を使用し、アプリ全体の状態（ユーザー情報、保有株情報、アラート情報など）を管理します。
- **状態の例**:
  - ユーザーのログイン状態（`isAuthenticated`）。
  - ユーザーの保有株情報（`stocks`）。
  - 株の価格情報（`stockPrices`）。
  - アラート情報（`alerts`）。

#### 6.4.2 ローカルステート管理

- 各ページやコンポーネント内で管理する状態（フォーム入力内容やダイアログの表示状態など）は、React のローカルステートで管理します。
- 例:
  - 株情報フォームの入力内容（`stockForm`）。
  - 株編集モーダルの表示状態（`isModalOpen`）。

---

### 6.5 API 通信

#### 6.5.1 API 通信の設計

- **GET リクエスト**:
  - ユーザーの株情報を取得する API（例: `/api/stocks`）。
  - 株の取引履歴を取得する API（例: `/api/transactions`）。
  - アラート情報を取得する API（例: `/api/alerts`）。
- **POST リクエスト**:
  - 新しい株を登録する API（例: `/api/stocks/add`）。
  - 株の取引を登録する API（例: `/api/transactions/add`）。
  - アラートを設定する API（例: `/api/alerts/add`）。
- **エラーハンドリング**:
  - 通信エラーや API からのエラーレスポンスを適切に処理し、ユーザーにエラーメッセージを表示します（例: 「通信エラーが発生しました」）。

---

### 6.6 レスポンシブデザイン

- **使用技術**: Bootstrap を活用し、デスクトップ・タブレット・スマートフォンの各デバイスに対応したレイアウトを提供します。
- **設計ポイント**:
  - メインコンテンツを中心に、柔軟にレイアウトを変更。
  - ナビゲーションメニューをドロップダウンまたはハンバーガーメニューにして、狭い画面でも快適に操作できるようにします。

---

### 6.7 アクセシビリティ

- **キーボード操作**:
  - フォームやボタン、ナビゲーションリンクはキーボードでも操作できるように設計します。
- **スクリーンリーダー対応**:
  - 必要な部分には`aria-label`や`aria-describedby`を追加し、視覚的に支援が必要なユーザーにも情報が正しく伝わるようにします。

---

ションに配慮した設計を行います。

## 7. セキュリティ設計

### 7.1 ユーザー認証

JWT を使用して、ログイン後のユーザー認証を行います。トークンはヘッダーに含まれ、すべての API リクエストに付加されます。

### 7.2 データ暗号化

ユーザーのパスワードは、ハッシュ化（bcrypt）してデータベースに保存します。通信はすべて HTTPS で暗号化され、外部 API との通信にもセキュリティを確保します。

### 7.3 API 認証

外部 API（株価情報 API）のアクセスには、API キーや OAuth などを使用します。

### 7.4 アクセス制御

ユーザーの情報には、他のユーザーがアクセスできないように制限します。ログインしたユーザーのみ、自分の株情報やアラートにアクセスできます。

---

## 8. エラーハンドリング

### 8.1 フロントエンド

React で発生するエラーは、`ErrorBoundary`コンポーネントでキャッチし、適切なエラーメッセージを表示します。API リクエスト失敗時には、エラーメッセージをポップアップで通知します。

### 8.2 バックエンド

Spring Boot では、`@ControllerAdvice`を使用してエラーをグローバルに処理し、ユーザーに意味のあるエラーメッセージを JSON 形式で返します。

### 8.3 ログ管理

バックエンドでは、Logback を使用して、重要なエラーや例外をログに記録します。運用担当者に通知を送信し、迅速な対応が可能です。

---

## 9. テスト

### 9.1 ユニットテスト

- **JUnit**: バックエンドの Java コードのユニットテストを実施。
- **Jest**: React コンポーネントのユニットテスト。

### 9.2 統合テスト

- **Spring Boot**: API の統合テストを`@SpringBootTest`を使用して実施。

### 9.3 UI テスト

- **Cypress**: エンドツーエンドの UI テスト。

### 9.4 セキュリティテスト

- **OWASP ZAP**: セキュリティ脆弱性

のスキャン。

---

## 10. デプロイ

### 10.1 開発環境

- **Docker**を使用し、開発環境をコンテナ化します。フロントエンド、バックエンド、データベースがそれぞれ独立したコンテナとして動作します。

### 10.2 本番環境

- 本番環境には**AWS**または**GCP**を利用して、インフラを提供します。CI/CD は GitHub Actions を使って実行します。
